<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Eventos</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .calendar-container {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .top-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .navigation-controls {
            display: flex;
            gap: 10px;
        }
        
        .today-btn, .nav-btn {
            background-color: #3f51b5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .month-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            flex-grow: 1;
        }
        
        .view-controls {
            display: flex;
            gap: 5px;
        }
        
        .view-btn {
            background-color: #3f51b5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .view-btn.active {
            background-color: #7986cb;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto repeat(6, 1fr);
            flex-grow: 1;
            height: 100%;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        
        .calendar.week-view {
            grid-template-columns: 100px repeat(7, 1fr);
            grid-template-rows: auto repeat(24, 1fr);
        }
        
        .calendar.day-view {
            grid-template-columns: 100px 1fr;
            grid-template-rows: auto repeat(24, 1fr);
        }
        
        .calendar.list-view {
            display: block;
            overflow-y: auto;
            padding: 20px;
        }
        
        .calendar-header {
            background-color: #f9f9f9;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        
        .day-cell {
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            padding: 5px;
            position: relative;
            overflow-y: auto;
            height: 100%;
        }
        
        .time-slot {
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            padding: 5px;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: flex-start;
        }
        
        .time-label {
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
            padding: 10px 5px;
            font-size: 12px;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .week-day-header {
            background-color: #f9f9f9;
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 14px;
        }
        
        .day-header-date {
            background-color: #f9f9f9;
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 16px;
        }
        
        .list-view-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .list-date-group {
            margin-bottom: 30px;
        }
        
        .list-date-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ddd;
        }
        
        .list-event-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .list-event-item:hover {
            background-color: #e3f2fd;
        }
        
        .list-event-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .list-event-content {
            flex-grow: 1;
        }
        
        .list-event-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .list-event-time {
            color: #666;
            font-size: 14px;
        }
        
        .week-event, .day-event {
            position: absolute;
            left: 2px;
            right: 2px;
            background-color: #3f51b5;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: grab;
            z-index: 10;
        }
        
        .time-slot {
            position: relative;
        }
        
        .all-day-slot {
            background-color: #f0f0f0;
            min-height: 40px;
        }
        
        .week-event {
            position: relative;
            margin-bottom: 2px;
        }
        
        .empty-time-slot {
            background-color: #fafafa;
        }
        
        .current-time-slot {
            background-color: #e3f2fd;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px;
        }
        
        .other-month {
            background-color: #f5f5f5;
            color: #aaa;
        }
        
        .today {
            background-color: #e3f2fd;
        }
        
        .selected-day {
            outline: 2px solid #3f51b5;
        }
        
        .event {
            margin-bottom: 5px;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 12px;
            cursor: grab;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .side-panel {
            width: 400px;
            background-color: #ffffff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .search-section input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .patient-data-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .patient-data-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-historial {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-modificar {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group.full-width {
            flex: 1 1 100%;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background-color: #f8f9fa;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .note {
            font-size: 11px;
            color: #666;
            font-weight: normal;
        }
        
        .treatment-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .treatment-input input {
            flex: 1;
        }
        
        .btn-add-treatment {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .required-note {
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }
        
        .appointment-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .time-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .doctor-section {
            margin-bottom: 20px;
        }
        
        .doctor-section label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .doctor-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .doctor-tag {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .doctor-tag:hover {
            background-color: #dee2e6;
            transform: translateY(-1px);
        }
        
        .doctor-tag.active:hover {
            background-color: #0056b3;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        select[multiple] {
            height: auto;
            min-height: 100px;
        }
        
        select[multiple] option {
            padding: 5px;
            margin: 2px 0;
        }
        
        select[multiple] option:checked {
            background-color: #3f51b5;
            color: white;
        }
        
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #3f51b5;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .event-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .form-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-btn {
            background-color: #3f51b5;
            color: white;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        .reset-btn {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .color-picker {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.selected {
            border-color: #000;
        }

        /* Colores predefinidos para eventos */
        .event-color-1 { background-color: #4CAF50; }
        .event-color-2 { background-color: #2196F3; }
        .event-color-3 { background-color: #f44336; }
        .event-color-4 { background-color: #FF9800; }
        .event-color-5 { background-color: #9C27B0; }
        .event-color-6 { background-color: #795548; }
        .event-color-7 { background-color: #607D8B; }
        .event-color-8 { background-color: #E91E63; }
        
        .form-field {
            margin-bottom: 15px;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .extended-form-section {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        /* Estilos para que se vea exactamente como en la imagen */
        .color-input {
            height: 36px;
        }

        /* Estilos adicionales para el formulario de citas médicas */
        .search-section input:focus,
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #f44336;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.25);
        }
        
        .btn-historial:hover {
            background-color: #138496;
        }
        
        .btn-modificar:hover {
            background-color: #e0a800;
        }
        
        .btn-add-treatment:hover {
            background-color: #218838;
        }
        
        .doctor-tag:hover {
            background-color: #dee2e6;
            transform: translateY(-1px);
        }
        
        .doctor-tag.active:hover {
            background-color: #0056b3;
        }
        
        .treatment-input input:focus + .btn-add-treatment {
            background-color: #218838;
        }
        
        .patient-data-section {
            transition: all 0.3s ease;
        }
        
        .patient-data-section:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .appointment-section {
            transition: all 0.3s ease;
        }
        
        .appointment-section:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .panel-content {
            scrollbar-width: thin;
            scrollbar-color: #dee2e6 #f8f9fa;
        }
        
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .panel-content::-webkit-scrollbar-track {
            background: #f8f9fa;
        }
        
        .panel-content::-webkit-scrollbar-thumb {
            background-color: #dee2e6;
            border-radius: 4px;
        }
        
        .panel-content::-webkit-scrollbar-thumb:hover {
            background-color: #adb5bd;
        }
        
        .form-actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .required-note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 11px;
            color: #856404;
        }
        
        .patient-data-section h4 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .search-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .search-section input {
            background-color: white;
            font-weight: 500;
        }
        
        .time-section .form-group {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .time-section .form-group:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
        }
        
        .time-section .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .time-section .form-group input {
            background-color: white;
            border: 1px solid #ddd;
            font-size: 14px;
            padding: 10px;
        }
        
        .time-section .form-group input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        @media (max-width: 768px) {
            .side-panel {
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .time-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .doctor-tags {
                justify-content: center;
            }
        }

        /* Estilos para Drag and Drop */
        .event[draggable="true"] {
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .event[draggable="true"]:active {
            cursor: grabbing;
        }
        
        .event.dragging {
            cursor: grabbing;
            opacity: 0.7;
        }
        
        .event[draggable="true"]:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            position: relative;
        }
        
        .event.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.05);
            z-index: 1000;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .day-cell.drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196F3 !important;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }
        
        .day-cell {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .drag-ghost {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        /* Indicador visual cuando se puede soltar */
        .drop-zone-active {
            background-color: #e8f5e8 !important;
            border: 2px solid #4caf50 !important;
        }
        
        /* Estilo para eventos siendo arrastrados */
        .event-being-dragged {
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="top-controls">
            <div class="navigation-controls">
                <button id="today-btn" class="today-btn">Today</button>
                <button id="prev-btn" class="nav-btn">&lt;</button>
                <button id="next-btn" class="nav-btn">&gt;</button>
            </div>
            <div class="month-title" id="month-title">julio de 2025</div>
            <div class="view-controls">
                <button class="view-btn active" data-view="month">Month</button>
                <button class="view-btn" data-view="week">Week</button>
                <button class="view-btn" data-view="day">Day</button>
                <button class="view-btn" data-view="list">List</button>
            </div>
        </div>
        
        <div class="calendar" id="calendar">
            <!-- Cabeceras de día de la semana -->
            <div class="calendar-header">dom</div>
            <div class="calendar-header">lun</div>
            <div class="calendar-header">mar</div>
            <div class="calendar-header">mié</div>
            <div class="calendar-header">jue</div>
            <div class="calendar-header">vie</div>
            <div class="calendar-header">sáb</div>
            
            <!-- Las celdas de días se generarán dinámicamente con JavaScript -->
        </div>
    </div>
    
    <div class="side-panel">
        <div class="panel-header">
            <h3>Agregar cita</h3>
            <button class="close-btn" id="close-panel">×</button>
        </div>
        
        <div class="panel-content">
            <div class="search-section">
                <label>Buscar paciente</label>
                <input type="text" id="search-patient" placeholder="VICTOR MANUEL LUNA RAMOS">
            </div>
            
            <div class="patient-data-section">
                <h4>Datos paciente</h4>
                <div class="data-actions">
                    <button class="btn-historial">Historial</button>
                    <button class="btn-modificar">Modificar datos</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre(s)*</label>
                        <input type="text" id="patient-name" placeholder="">
                    </div>
                    <div class="form-group">
                        <label>Apellido paterno*</label>
                        <input type="text" id="patient-lastname1" placeholder="">
                    </div>
                    <div class="form-group">
                        <label>Apellido materno*</label>
                        <input type="text" id="patient-lastname2" placeholder="">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Dirección</label>
                        <input type="text" id="patient-address" placeholder="">
                    </div>
                    <div class="form-group">
                        <label>Teléfono*</label>
                        <input type="tel" id="patient-phone" placeholder="">
                    </div>
                    <div class="form-group">
                        <label>Teléfono 2</label>
                        <input type="tel" id="patient-phone2" placeholder="">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Seleccione Aseguranza</label>
                        <select id="patient-insurance">
                            <option value="">Seleccionar...</option>
                            <option value="seguro1">Seguro Médico 1</option>
                            <option value="seguro2">Seguro Médico 2</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Correo* <span class="note">(el correo es importante para enviarle al cliente su recordatorio de cita)</span></label>
                        <input type="email" id="patient-email" placeholder="">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Tratamiento(s)</label>
                        <div class="treatment-input">
                            <input type="text" id="treatment-search" placeholder="REVISION" value="REVISION">
                            <button class="btn-add-treatment">+</button>
                        </div>
                        <textarea id="treatment-notes" placeholder="Nota o mensaje, para la cita."></textarea>
                    </div>
                </div>
                
                <div class="required-note">
                    <em>* Campos obligatorios</em>
                </div>
            </div>
            
            <div class="appointment-section">
                <div class="time-section">
                    <div class="form-group">
                        <label>Hora inicio</label>
                        <input type="datetime-local" id="start-time" value="2025-07-08T10:00">
                    </div>
                    <div class="form-group">
                        <label>Hora final</label>
                        <input type="datetime-local" id="end-time" value="2025-07-08T10:30">
                    </div>
                </div>
                
                <div class="doctor-section">
                    <label>Médico</label>
                    <div class="doctor-tags">
                        <span class="doctor-tag active">Julieta Luna</span>
                        <span class="doctor-tag">Lucero Cortes</span>
                        <span class="doctor-tag">Angel Manuel Martinez</span>
                        <span class="doctor-tag">Alejandra Abigail</span>
                        <span class="doctor-tag">Fernando Garcia</span>
                        <span class="doctor-tag">German Gaxiola</span>
                        <span class="doctor-tag">Irma Fernandez</span>
                        <span class="doctor-tag">Angel Martinez 2</span>
                        <span class="doctor-tag">Jose Cisneros</span>
                        <span class="doctor-tag">Saul Hernandez</span>
                        <span class="doctor-tag">Christopher Verduzco</span>
                        <span class="doctor-tag">Thania Paniagua</span>
                        <span class="doctor-tag">Angela Gonzalez</span>
                        <span class="doctor-tag">GABRIELA RUIZ</span>
                        <span class="doctor-tag">JORGE ARMANDO LOPEZ</span>
                        <span class="doctor-tag">MAIKEL HERMIDA</span>
                        <span class="doctor-tag">JESUS IBARRA</span>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn-secondary" id="cancel-appointment">Cerrar</button>
                    <button class="btn-primary" id="save-appointment">Agendar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para añadir evento -->
    <div class="overlay" id="overlay"></div>
    <div class="event-form" id="event-form">
        <h3>Añadir evento</h3>
        <div class="form-field">
            <label>Título</label>
            <input type="text" id="new-event-title" placeholder="Título del evento">
        </div>
        
        <div class="form-field">
            <label>Hora</label>
            <input type="time" id="new-event-time">
        </div>
        
        <div class="form-field">
            <label>Color</label>
            <div class="color-picker">
                <div class="color-option event-color-1 selected" data-color="1"></div>
                <div class="color-option event-color-2" data-color="2"></div>
                <div class="color-option event-color-3" data-color="3"></div>
                <div class="color-option event-color-4" data-color="4"></div>
                <div class="color-option event-color-5" data-color="5"></div>
                <div class="color-option event-color-6" data-color="6"></div>
                <div class="color-option event-color-7" data-color="7"></div>
                <div class="color-option event-color-8" data-color="8"></div>
            </div>
        </div>
        
        <div class="extended-form-section">
            <div class="section-title">Opciones avanzadas</div>
            
            <div class="toggle-container">
                <span>Start Editable</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="new-start-editable">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-container">
                <span>Duration Editable</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="new-duration-editable">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="form-field">
                <label>Display</label>
                <input type="text" id="new-event-display">
            </div>
            
            <div class="form-field">
                <label>Extended Props</label>
                <input type="text" id="new-event-extended-props">
            </div>
            
            <div class="form-field">
                <label>Background Color</label>
                <input type="text" id="new-event-background-color" placeholder="#FFFFFF">
            </div>
            
            <div class="form-field">
                <label>Text Color</label>
                <input type="text" id="new-event-text-color" placeholder="#000000">
            </div>
        </div>
        
        <div class="form-buttons">
            <button class="cancel-btn" id="cancel-event">Cancelar</button>
            <button class="save-btn" id="save-event">Guardar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let currentDate = new Date('2025-07-11'); // Fecha de la imagen
        let selectedDate = new Date('2025-07-11');
        let selectedEvent = null;
        let selectedColorOption = '1';
        let nextEventId = 1;
        let currentView = 'month'; // month, week, day, list
        
        // Eventos precargados según la imagen
        let events = {
            '2025-07-06': [
                { id: 1, title: 'Project Kickoff', time: '', color: '6', backgroundColor: '#795548', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-07': [
                { id: 2, title: 'Team Collaboration', time: '', color: '4', backgroundColor: '#FF9800', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-08': [
                { id: 3, title: 'Client Presentation', time: '10:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-09': [
                { id: 4, title: 'Strategic Planning', time: '7:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-10': [
                { id: 5, title: 'Product Development', time: '', color: '2', backgroundColor: '#2196F3', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-11': [
                { id: 6, title: 'Training Session', time: '10:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-13': [
                { id: 7, title: 'Quarterly Review', time: '16:00', color: '1', backgroundColor: '#4CAF50', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-14': [
                { id: 8, title: 'Innovation Workshop', time: '10:00', color: '1', backgroundColor: '#4CAF50', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-15': [
                { id: 9, title: 'Marketing Strategy', time: '7:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-16': [
                { id: 10, title: 'Budget Planning', time: '6:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-17': [
                { id: 11, title: 'Performance Evaluation', time: '', color: '6', backgroundColor: '#795548', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-18': [
                { id: 12, title: '9:00 p.m. Business Development', time: '9:00', color: '1', backgroundColor: '#4CAF50', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-19': [
                { id: 13, title: '9:00 p.m. Customer Feedback', time: '9:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-20': [
                { id: 14, title: '10:00 p.m. Quality Assurance', time: '10:00', color: '1', backgroundColor: '#4CAF50', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-21': [
                { id: 15, title: '6:00 p.m. Sales Pitch', time: '6:00', color: '2', backgroundColor: '#2196F3', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-22': [
                { id: 16, title: '4:00 p.m. Leadership Training', time: '4:00', color: '5', backgroundColor: '#9C27B0', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-23': [
                { id: 17, title: '3:00 p.m. Market Research', time: '3:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-24': [
                { id: 18, title: '8:00 p.m. Cross-functional Meeting', time: '8:00', color: '3', backgroundColor: '#f44336', textColor: '#FFFFFF', startEditable: true, durationEditable: true, display: '', extendedProps: '', editable: true }
            ],
            '2025-07-25': [
                { id: 19, title: '7:00 p.m. Employee Recognition', time: '7:00', color: '4', backgroundColor: '#FF9800', textColor: '#FFFFFF', startEditable: false, durationEditable: false, display: '', extendedProps: '', editable: false }
            ],
            '2025-07-26': [
                { id: 20, title: 'Stakeholder Consultation', time: '', color: '1', backgroundColor: '#4CAF50', textColor: '#FFFFFF', startEditable: false, durationEditable: false, display: '', extendedProps: '', editable: false }
            ]
        };
        
        // Calcular el siguiente ID disponible
        function calculateNextEventId() {
            let maxId = 0;
            
            // Revisar todos los eventos en todas las fechas
            for (const dateStr in events) {
                if (events.hasOwnProperty(dateStr)) {
                    for (const event of events[dateStr]) {
                        if (event.id > maxId) {
                            maxId = event.id;
                        }
                    }
                }
            }
            
            return maxId + 1;
        }

        // Inicializar el calendario
        document.addEventListener('DOMContentLoaded', function() {
            // Calcular el siguiente ID disponible
            nextEventId = calculateNextEventId();
            
            renderCalendar();
            updateSidePanel();
            
            // Eventos para navegar entre meses
            document.getElementById('prev-btn').addEventListener('click', function() {
                if (currentView === 'month') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                } else if (currentView === 'week') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else if (currentView === 'day') {
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                
                // Llamada al backend para notificar cambio de período
                const periodData = {
                    action: 'navigate_previous',
                    currentView: currentView,
                    currentDate: formatDate(currentDate),
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth() + 1, // Mes en formato 1-12
                    day: currentDate.getDate(),
                    timestamp: new Date().toISOString()
                };
                
                // Mostrar alerta de navegación
                alert('Navegando al mes anterior...');
                
                // Intento de petición HTTP al backend (con manejo de errores mejorado)
                try {
                    fetch('/api/calendar/navigate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(periodData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ Respuesta del backend:', data);
                    })
                    .catch(error => {
                        console.error('❌ Error en petición:', error);
                    });
                } catch (error) {
                    console.error('Error al hacer fetch:', error);
                }
                
                renderCalendar();
            });
            
            document.getElementById('next-btn').addEventListener('click', function() {
                if (currentView === 'month') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                } else if (currentView === 'week') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (currentView === 'day') {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Llamada al backend para notificar cambio de período
                const periodData = {
                    action: 'navigate_next',
                    currentView: currentView,
                    currentDate: formatDate(currentDate),
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth() + 1, // Mes en formato 1-12
                    day: currentDate.getDate(),
                    timestamp: new Date().toISOString()
                };
                
                // Mostrar alerta de navegación
                alert('Navegando al mes siguiente...');
                
                // Intento de petición HTTP al backend (con manejo de errores mejorado)
                try {
                    fetch('/api/calendar/navigate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(periodData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ Respuesta del backend:', data);
                    })
                    .catch(error => {
                        console.error('❌ Error en petición:', error);
                    });
                } catch (error) {
                    console.error('Error al hacer fetch:', error);
                }
                
                renderCalendar();
            });
            
            // Botón de hoy
            document.getElementById('today-btn').addEventListener('click', function() {
                currentDate = new Date('2025-07-11'); // Usar la fecha de la imagen como "hoy"
                selectedDate = new Date('2025-07-11');
                
                // Llamada al backend para notificar navegación a "hoy"
                const periodData = {
                    action: 'navigate_today',
                    currentView: currentView,
                    currentDate: formatDate(currentDate),
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth() + 1, // Mes en formato 1-12
                    day: currentDate.getDate(),
                    timestamp: new Date().toISOString()
                };
                
                // Mostrar alerta de navegación
                alert('Navegando a hoy...');
                
                // Intento de petición HTTP al backend (con manejo de errores mejorado)
                try {
                    fetch('/api/calendar/navigate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(periodData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ Respuesta del backend:', data);
                    })
                    .catch(error => {
                        console.error('❌ Error en petición:', error);
                    });
                } catch (error) {
                    console.error('Error al hacer fetch:', error);
                }
                
                renderCalendar();
                updateSidePanel();
            });
            
            // Cambiar de vista
            document.querySelectorAll('.view-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.view-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    currentView = this.getAttribute('data-view');
                    renderCalendar();
                });
            });
            
            // Configuración de eventos para el formulario de eventos
            document.getElementById('save-event').addEventListener('click', saveEvent);
            document.getElementById('cancel-event').addEventListener('click', closeEventForm);
            document.getElementById('overlay').addEventListener('click', closeEventForm);
            
            // Selector de colores
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedColorOption = this.getAttribute('data-color');
                });
            });
            
            // Eventos para editar un evento existente
            document.getElementById('submit-event-btn').addEventListener('click', updateEvent);
            document.getElementById('reset-event-btn').addEventListener('click', resetEventForm);
            
            // Cargar los eventos desde localStorage si existen
            const savedEvents = localStorage.getItem('calendarEvents');
            if (savedEvents) {
                events = JSON.parse(savedEvents);
                nextEventId = calculateNextEventId();
            }
            
            // Inicializar el formulario de citas médicas
            initializeMedicalAppointmentForm();
        });

        // Función para renderizar el calendario
        function renderCalendar() {
            const calendarElement = document.getElementById('calendar');
            
            // Limpiar clases de vista
            calendarElement.classList.remove('week-view', 'day-view', 'list-view');
            
            switch(currentView) {
                case 'month':
                    renderMonthView();
                    break;
                case 'week':
                    calendarElement.classList.add('week-view');
                    renderWeekView();
                    break;
                case 'day':
                    calendarElement.classList.add('day-view');
                    renderDayView();
                    break;
                case 'list':
                    calendarElement.classList.add('list-view');
                    renderListView();
                    break;
                default:
                    renderMonthView();
            }
        }
        
        // Función para renderizar la vista de mes
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Actualizar el encabezado del mes y año
            const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                               'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            document.getElementById('month-title').textContent = `${monthNames[month]} de ${year}`;
            
            // Obtener el primer día del mes y los días totales
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Obtener el día de la semana del primer día (0 = Domingo, 6 = Sábado)
            const firstDayOfWeek = firstDayOfMonth.getDay();
            
            // Limpiar el contenedor del calendario
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = '';
            
            // Añadir cabeceras de día
            const dayHeaders = ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.classList.add('calendar-header');
                header.textContent = day;
                calendarElement.appendChild(header);
            });
            
            // Añadir días del mes anterior
            const lastMonth = new Date(year, month, 0);
            const daysInLastMonth = lastMonth.getDate();
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                const day = daysInLastMonth - firstDayOfWeek + i + 1;
                const lastMonthDate = new Date(year, month - 1, day);
                
                addDayToCalendar(lastMonthDate, true);
            }
            
            // Añadir días del mes actual
            for (let day = 1; day <= daysInMonth; day++) {
                const currentMonthDate = new Date(year, month, day);
                addDayToCalendar(currentMonthDate, false);
            }
            
            // Añadir días del mes siguiente
            const cellsAdded = firstDayOfWeek + daysInMonth;
            const cellsNeeded = Math.ceil(cellsAdded / 7) * 7;
            const daysToAdd = cellsNeeded - cellsAdded;
            
            for (let day = 1; day <= daysToAdd; day++) {
                const nextMonthDate = new Date(year, month + 1, day);
                addDayToCalendar(nextMonthDate, true);
            }
        }
        
        // Función para renderizar la vista de semana
        function renderWeekView() {
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = '';
            
            // Obtener el inicio de la semana (domingo)
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            
            // Actualizar título
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            document.getElementById('month-title').textContent = 
                `${startOfWeek.getDate()} ${getMonthName(startOfWeek.getMonth())} - ${endOfWeek.getDate()} ${getMonthName(endOfWeek.getMonth())} ${endOfWeek.getFullYear()}`;
            
            // Añadir header vacío para la columna de tiempo
            const emptyHeader = document.createElement('div');
            emptyHeader.classList.add('calendar-header');
            calendarElement.appendChild(emptyHeader);
            
            // Añadir headers de días de la semana
            const dayNames = ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                
                const weekDayHeader = document.createElement('div');
                weekDayHeader.classList.add('week-day-header');
                weekDayHeader.innerHTML = `${dayNames[i]}<br>${dayDate.getDate()}`;
                
                // Agregar funcionalidad de drop para los encabezados de día
                weekDayHeader.addEventListener('dragover', function(e) {
                    e.preventDefault(); // Permite el drop
                    weekDayHeader.classList.add('drag-over');
                });
                
                weekDayHeader.addEventListener('dragleave', function() {
                    weekDayHeader.classList.remove('drag-over');
                });
                
                weekDayHeader.addEventListener('drop', function(e) {
                    e.preventDefault();
                    weekDayHeader.classList.remove('drag-over');
                    
                    // Obtener el evento y su fecha original
                    const eventId = e.dataTransfer.getData('text/plain');
                    const originalDateStr = e.dataTransfer.getData('originalDate');
                    
                    if (eventId && originalDateStr) {
                        const newDate = new Date(dayDate);
                        moveEventToDate(parseInt(eventId), originalDateStr, formatDate(newDate));
                        renderCalendar();
                    }
                });
                
                calendarElement.appendChild(weekDayHeader);
            }
            
            // Añadir fila "all-day"
            const allDayLabel = document.createElement('div');
            allDayLabel.classList.add('time-label');
            allDayLabel.textContent = 'all-day';
            calendarElement.appendChild(allDayLabel);
            
            for (let day = 0; day < 7; day++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + day);
                
                const allDaySlot = document.createElement('div');
                allDaySlot.classList.add('time-slot');
                allDaySlot.classList.add('all-day-slot');
                
                // Añadir eventos "all-day" para este día
                addAllDayEvents(allDaySlot, dayDate);
                
                // Hacer que el slot all-day sea un destino válido para soltar
                allDaySlot.addEventListener('dragover', function(e) {
                    e.preventDefault(); // Permite el drop
                    allDaySlot.classList.add('drag-over');
                });
                
                allDaySlot.addEventListener('dragleave', function() {
                    allDaySlot.classList.remove('drag-over');
                });
                
                allDaySlot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    allDaySlot.classList.remove('drag-over');
                    
                    // Obtener el evento y su fecha original
                    const eventId = e.dataTransfer.getData('text/plain');
                    const originalDateStr = e.dataTransfer.getData('originalDate');
                    
                    if (eventId && originalDateStr) {
                        moveEventToDate(parseInt(eventId), originalDateStr, formatDate(dayDate));
                        renderCalendar();
                    }
                });
                
                calendarElement.appendChild(allDaySlot);
            }
            
            // Añadir filas de tiempo (6:00 AM - 6:00 PM como en la imagen)
            const startHour = 6;
            const endHour = 18;
            
            for (let hour = startHour; hour <= endHour; hour++) {
                // Añadir etiqueta de tiempo
                const timeLabel = document.createElement('div');
                timeLabel.classList.add('time-label');
                const displayHour = hour > 12 ? hour - 12 : hour;
                const ampm = hour < 12 ? 'a.m.' : 'p.m.';
                timeLabel.textContent = `${displayHour}:00 ${ampm}`;
                calendarElement.appendChild(timeLabel);
                
                // Añadir celdas para cada día de la semana
                for (let day = 0; day < 7; day++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + day);
                    
                    const timeSlot = document.createElement('div');
                    timeSlot.classList.add('time-slot');
                    
                    // Añadir eventos para esta hora
                    addEventsToTimeSlot(timeSlot, dayDate, hour);
                    
                    // Hacer que el slot de tiempo sea un destino válido para soltar
                    timeSlot.addEventListener('dragover', function(e) {
                        e.preventDefault(); // Permite el drop
                        timeSlot.classList.add('drag-over');
                    });
                    
                    timeSlot.addEventListener('dragleave', function() {
                        timeSlot.classList.remove('drag-over');
                    });
                    
                    timeSlot.addEventListener('drop', function(e) {
                        e.preventDefault();
                        timeSlot.classList.remove('drag-over');
                        
                        // Obtener el evento y su fecha original
                        const eventId = e.dataTransfer.getData('text/plain');
                        const originalDateStr = e.dataTransfer.getData('originalDate');
                        
                        if (eventId && originalDateStr) {
                            // Mover el evento y actualizar la hora si es necesario
                            const newDate = new Date(dayDate);
                            newDate.setHours(hour);
                            
                            moveEventToDate(parseInt(eventId), originalDateStr, formatDate(newDate));
                            renderCalendar();
                        }
                    });
                    
                    calendarElement.appendChild(timeSlot);
                }
            }
        }
        
        // Función para renderizar la vista de día
        function renderDayView() {
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = '';
            
            // Actualizar título
            const dayNames = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
            document.getElementById('month-title').textContent = 
                `${currentDate.getDate()} de ${getMonthName(currentDate.getMonth())} de ${currentDate.getFullYear()}`;
            
            // Añadir header vacío para la columna de tiempo
            const emptyHeader = document.createElement('div');
            emptyHeader.classList.add('calendar-header');
            calendarElement.appendChild(emptyHeader);
            
            // Añadir header del día
            const dayHeader = document.createElement('div');
            dayHeader.classList.add('day-header-date');
            dayHeader.textContent = dayNames[currentDate.getDay()];
            calendarElement.appendChild(dayHeader);
            
            // Añadir fila "all-day"
            const allDayLabel = document.createElement('div');
            allDayLabel.classList.add('time-label');
            allDayLabel.textContent = 'all-day';
            calendarElement.appendChild(allDayLabel);
            
            const allDaySlot = document.createElement('div');
            allDaySlot.classList.add('time-slot');
            
            // Añadir eventos "all-day" para este día
            addAllDayEvents(allDaySlot, currentDate);
            
            calendarElement.appendChild(allDaySlot);
            
            // Añadir filas de tiempo (6:00 AM - 6:00 PM)
            const startHour = 6;
            const endHour = 18;
            
            for (let hour = startHour; hour <= endHour; hour++) {
                // Añadir etiqueta de tiempo
                const timeLabel = document.createElement('div');
                timeLabel.classList.add('time-label');
                const displayHour = hour > 12 ? hour - 12 : hour;
                const ampm = hour < 12 ? 'a.m.' : 'p.m.';
                timeLabel.textContent = `${displayHour}:00 ${ampm}`;
                calendarElement.appendChild(timeLabel);
                
                // Añadir celda del día
                const timeSlot = document.createElement('div');
                timeSlot.classList.add('time-slot');
                
                // Añadir eventos para esta hora
                addEventsToTimeSlot(timeSlot, currentDate, hour);
                
                calendarElement.appendChild(timeSlot);
            }
        }
        
        // Función para renderizar la vista de lista
        function renderListView() {
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = '';
            
            // Actualizar título
            document.getElementById('month-title').textContent = 
                `${currentDate.getDate()} jul ${currentDate.getFullYear()}`;
            
            // Crear contenedor de lista
            const listContainer = document.createElement('div');
            listContainer.classList.add('list-view-container');
            
            // Agrupar eventos por fecha
            const groupedEvents = {};
            
            for (const dateStr in events) {
                if (events.hasOwnProperty(dateStr)) {
                    const eventDate = new Date(dateStr);
                    const dateKey = formatDate(eventDate);
                    
                    if (!groupedEvents[dateKey]) {
                        groupedEvents[dateKey] = {
                            date: eventDate,
                            events: []
                        };
                    }
                    
                    groupedEvents[dateKey].events.push(...events[dateStr]);
                }
            }
            
            // Ordenar fechas
            const sortedDates = Object.keys(groupedEvents).sort();
            
            sortedDates.forEach(dateKey => {
                const dateGroup = groupedEvents[dateKey];
                
                // Crear grupo de fecha
                const dateGroupElement = document.createElement('div');
                dateGroupElement.classList.add('list-date-group');
                
                // Header de fecha
                const dateHeader = document.createElement('div');
                dateHeader.classList.add('list-date-header');
                const dayNames = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
                dateHeader.textContent = `${dayNames[dateGroup.date.getDay()]} ${dateGroup.date.getDate()} de ${getMonthName(dateGroup.date.getMonth())} de ${dateGroup.date.getFullYear()}`;
                dateGroupElement.appendChild(dateHeader);
                
                // Eventos del día
                dateGroup.events.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.classList.add('list-event-item');
                    eventItem.setAttribute('data-event-id', event.id);
                    
                    // Color del evento
                    const colorDot = document.createElement('div');
                    colorDot.classList.add('list-event-color');
                    colorDot.style.backgroundColor = event.backgroundColor;
                    eventItem.appendChild(colorDot);
                    
                    // Contenido del evento
                    const eventContent = document.createElement('div');
                    eventContent.classList.add('list-event-content');
                    
                    const eventTitle = document.createElement('div');
                    eventTitle.classList.add('list-event-title');
                    eventTitle.textContent = event.title;
                    eventContent.appendChild(eventTitle);
                    
                    if (event.time) {
                        const eventTime = document.createElement('div');
                        eventTime.classList.add('list-event-time');
                        eventTime.textContent = event.time;
                        eventContent.appendChild(eventTime);
                    }
                    
                    eventItem.appendChild(eventContent);
                    
                    // Evento click
                    eventItem.addEventListener('click', function() {
                        selectedEvent = event;
                        selectedDate = dateGroup.date;
                        updateSidePanel();
                    });
                    
                    dateGroupElement.appendChild(eventItem);
                });
                
                listContainer.appendChild(dateGroupElement);
            });
            
            calendarElement.appendChild(listContainer);
        }
        
        // Función para añadir un día al calendario
        function addDayToCalendar(date, isOtherMonth) {
            const day = date.getDate();
            const month = date.getMonth();
            const year = date.getFullYear();
            
            const dayCell = document.createElement('div');
            dayCell.classList.add('day-cell');
            
            if (isOtherMonth) {
                dayCell.classList.add('other-month');
            }
            
            // Destacar el día de hoy y el día seleccionado
            const today = new Date('2025-07-11');
            if (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear()) {
                dayCell.classList.add('today');
            }
            
            if (date.getDate() === selectedDate.getDate() && date.getMonth() === selectedDate.getMonth() && date.getFullYear() === selectedDate.getFullYear()) {
                dayCell.classList.add('selected-day');
            }
            
            // Añadir el número del día
            const dayNumber = document.createElement('div');
            dayNumber.classList.add('day-number');
            dayNumber.textContent = day;
            dayCell.appendChild(dayNumber);
            
            // Hacer que la celda del día sea un destino válido para soltar eventos
            dayCell.addEventListener('dragover', function(e) {
                e.preventDefault(); // Permite el drop
                e.stopPropagation();
                dayCell.classList.add('drag-over');
            });
            
            dayCell.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dayCell.classList.add('drag-over');
            });
            
            dayCell.addEventListener('dragleave', function(e) {
                // Solo quitar la clase si realmente salimos de la celda
                if (!dayCell.contains(e.relatedTarget)) {
                    dayCell.classList.remove('drag-over');
                }
            });
            
            dayCell.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dayCell.classList.remove('drag-over');
                
                // Obtener el evento y su fecha original
                const eventId = e.dataTransfer.getData('text/plain');
                const originalDateStr = e.dataTransfer.getData('originalDate');
                
                if (eventId && originalDateStr) {
                    const newDateStr = formatDate(date);
                    if (originalDateStr !== newDateStr) {
                        moveEventToDate(parseInt(eventId), originalDateStr, newDateStr);
                        renderCalendar();
                        updateSidePanel();
                        
                        // Mostrar confirmación visual
                        showDropConfirmation(dayCell);
                    }
                }
            });
            
            // Añadir eventos para este día
            const dateStr = formatDate(date);
            if (events[dateStr]) {
                events[dateStr].forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.classList.add('event');
                    eventElement.textContent = event.title;
                    
                    // Asignar color basado en el color del evento
                    eventElement.style.backgroundColor = event.backgroundColor || getColorForCode(event.color);
                    eventElement.style.color = event.textColor || '#FFFFFF';
                    
                    // Añadir el ID del evento como atributo de datos
                    eventElement.setAttribute('data-event-id', event.id);
                    
                    // Hacer que el evento sea arrastrable si es editable
                    if (event.editable !== false) { // Por defecto son editables
                        eventElement.setAttribute('draggable', 'true');
                        
                        eventElement.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('text/plain', event.id);
                            e.dataTransfer.setData('originalDate', dateStr);
                            e.dataTransfer.effectAllowed = 'move';
                            
                            // Añadir clase visual
                            eventElement.classList.add('dragging');
                            
                            // Guardar referencia del elemento siendo arrastrado
                            window.draggedElement = eventElement;
                            
                            // Hacer que otros eventos sean menos visibles
                            document.querySelectorAll('.event').forEach(el => {
                                if (el !== eventElement) {
                                    el.classList.add('event-being-dragged');
                                }
                            });
                        });
                        
                        eventElement.addEventListener('dragend', function(e) {
                            // Limpiar clases visuales
                            eventElement.classList.remove('dragging');
                            
                            // Restaurar visibilidad de otros eventos
                            document.querySelectorAll('.event').forEach(el => {
                                el.classList.remove('event-being-dragged');
                            });
                            
                            // Limpiar referencia
                            window.draggedElement = null;
                        });
                        
                        // Prevenir que el drag interfiera con el click
                        eventElement.addEventListener('mousedown', function(e) {
                            e.stopPropagation();
                        });
                    }
                    
                    // Añadir evento click para seleccionar el evento
                    eventElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectedEvent = event;
                        selectedDate = date;
                        updateSidePanel();
                    });
                    
                    dayCell.appendChild(eventElement);
                });
            }
            
            // Añadir evento click para seleccionar el día
            dayCell.addEventListener('click', function() {
                selectedDate = new Date(date);
                selectedEvent = null;
                renderCalendar();
                updateSidePanel();
            });
            
            // Añadir evento doble click para crear nuevo evento
            dayCell.addEventListener('dblclick', function() {
                selectedDate = new Date(date);
                showEventForm();
            });
            
            document.getElementById('calendar').appendChild(dayCell);
        }
        
        // Función para mover un evento de una fecha a otra
        function moveEventToDate(eventId, originalDateStr, newDateStr) {
            // Si la fecha original y nueva son iguales, no hacer nada
            if (originalDateStr === newDateStr) {
                return;
            }
            
            // Buscar el evento en la fecha original
            if (events[originalDateStr]) {
                const eventIndex = events[originalDateStr].findIndex(event => event.id === eventId);
                
                if (eventIndex !== -1) {
                    // Guardar una referencia al evento
                    const eventToMove = events[originalDateStr][eventIndex];
                    
                    // Eliminar el evento de la fecha original
                    events[originalDateStr].splice(eventIndex, 1);
                    
                    // Si no quedan eventos en esa fecha, eliminar la clave
                    if (events[originalDateStr].length === 0) {
                        delete events[originalDateStr];
                    }
                    
                    // Asegurarse de que exista un array para la nueva fecha
                    if (!events[newDateStr]) {
                        events[newDateStr] = [];
                    }
                    
                    // Añadir el evento a la nueva fecha
                    events[newDateStr].push(eventToMove);
                    
                    // Si el evento es una cita médica, actualizar la fecha de inicio y fin
                    if (eventToMove.appointmentData) {
                        const newDate = new Date(newDateStr);
                        
                        // Obtener las horas y minutos de las fechas originales
                        const startDate = new Date(eventToMove.appointmentData.startTime);
                        const endDate = new Date(eventToMove.appointmentData.endTime);
                        
                        // Crear nuevas fechas con la nueva fecha pero manteniendo la hora
                        const newStartDate = new Date(newDate);
                        newStartDate.setHours(startDate.getHours(), startDate.getMinutes());
                        
                        const newEndDate = new Date(newDate);
                        newEndDate.setHours(endDate.getHours(), endDate.getMinutes());
                        
                        // Actualizar las fechas en appointmentData
                        eventToMove.appointmentData.startTime = newStartDate.toISOString();
                        eventToMove.appointmentData.endTime = newEndDate.toISOString();
                        
                        // Actualizar extendedProps si existe
                        if (eventToMove.extendedProps) {
                            try {
                                const extendedProps = JSON.parse(eventToMove.extendedProps);
                                extendedProps.startTime = newStartDate.toISOString();
                                extendedProps.endTime = newEndDate.toISOString();
                                eventToMove.extendedProps = JSON.stringify(extendedProps);
                            } catch (e) {
                                console.error('Error al actualizar extendedProps:', e);
                            }
                        }
                        
                        // Actualizar la hora mostrada en el evento
                        eventToMove.time = newStartDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    // Guardar cambios en localStorage
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                    
                    // Mostrar mensaje de confirmación
                    console.log(`Evento movido de ${originalDateStr} a ${newDateStr}`);
                }
            }
        }
        
        // Función para mostrar confirmación visual cuando se suelta un evento
        function showDropConfirmation(dayCell) {
            // Crear elemento de confirmación
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #4caf50;
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 1000;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            confirmation.textContent = '✓ Movido';
            
            // Añadir al dayCell
            dayCell.style.position = 'relative';
            dayCell.appendChild(confirmation);
            
            // Mostrar con animación
            setTimeout(() => {
                confirmation.style.opacity = '1';
            }, 10);
            
            // Ocultar y eliminar después de 1 segundo
            setTimeout(() => {
                confirmation.style.opacity = '0';
                setTimeout(() => {
                    if (confirmation.parentNode) {
                        confirmation.parentNode.removeChild(confirmation);
                    }
                }, 300);
            }, 1000);
        }
        
        // Función para verificar si un evento es arrastrable
        function isEventDraggable(event) {
            return event.editable !== false && event.startEditable !== false;
        }
        
        // Función para formatear fecha
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Función para obtener color basado en código
        function getColorForCode(colorCode) {
            const colors = {
                '1': '#4CAF50',
                '2': '#2196F3',
                '3': '#f44336',
                '4': '#FF9800',
                '5': '#9C27B0',
                '6': '#795548',
                '7': '#607D8B',
                '8': '#E91E63'
            };
            return colors[colorCode] || '#4CAF50';
        }
        
        // Función para obtener nombre del mes
        function getMonthName(monthIndex) {
            const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                               'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            return monthNames[monthIndex];
        }
        
        // Función para añadir eventos a un slot de tiempo
        function addEventsToTimeSlot(timeSlot, date, hour) {
            const dateStr = formatDate(date);
            if (events[dateStr]) {
                events[dateStr].forEach(event => {
                    if (event.time) {
                        const eventHour = parseInt(event.time.split(':')[0]);
                        if (eventHour === hour) {
                            const eventElement = document.createElement('div');
                            eventElement.classList.add('week-event');
                            eventElement.textContent = event.title;
                            eventElement.style.backgroundColor = event.backgroundColor || getColorForCode(event.color);
                            eventElement.style.color = event.textColor || '#FFFFFF';
                            
                            // Hacer el evento arrastrable si es editable
                            if (event.editable !== false) {
                                eventElement.setAttribute('draggable', 'true');
                                eventElement.setAttribute('data-event-id', event.id);
                                
                                eventElement.addEventListener('dragstart', function(e) {
                                    e.dataTransfer.setData('text/plain', event.id);
                                    e.dataTransfer.setData('originalDate', dateStr);
                                    eventElement.classList.add('dragging');
                                });
                                
                                eventElement.addEventListener('dragend', function() {
                                    eventElement.classList.remove('dragging');
                                });
                            }
                            
                            eventElement.addEventListener('click', function(e) {
                                e.stopPropagation();
                                selectedEvent = event;
                                selectedDate = date;
                                updateSidePanel();
                            });
                            
                            timeSlot.appendChild(eventElement);
                        }
                    }
                });
            }
        }
        
        // Función para añadir eventos "all-day"
        function addAllDayEvents(timeSlot, date) {
            const dateStr = formatDate(date);
            if (events[dateStr]) {
                events[dateStr].forEach(event => {
                    if (!event.time || event.time === '') {
                        const eventElement = document.createElement('div');
                        eventElement.classList.add('week-event');
                        eventElement.textContent = event.title;
                        eventElement.style.backgroundColor = event.backgroundColor || getColorForCode(event.color);
                        eventElement.style.color = event.textColor || '#FFFFFF';
                        
                        // Hacer el evento arrastrable si es editable
                        if (event.editable !== false) {
                            eventElement.setAttribute('draggable', 'true');
                            eventElement.setAttribute('data-event-id', event.id);
                            
                            eventElement.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', event.id);
                                e.dataTransfer.setData('originalDate', dateStr);
                                eventElement.classList.add('dragging');
                            });
                            
                            eventElement.addEventListener('dragend', function() {
                                eventElement.classList.remove('dragging');
                            });
                        }
                        
                        eventElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectedEvent = event;
                            selectedDate = date;
                            updateSidePanel();
                        });
                        
                        timeSlot.appendChild(eventElement);
                    }
                });
            }
        }
        
        // Función para mostrar el formulario de eventos
        function showEventForm() {
            const overlay = document.getElementById('overlay');
            const eventForm = document.getElementById('event-form');
            
            if (overlay) overlay.style.display = 'block';
            if (eventForm) eventForm.style.display = 'block';
            
            // Limpiar el formulario si existen los elementos
            const titleInput = document.getElementById('new-event-title');
            const timeInput = document.getElementById('new-event-time');
            
            if (titleInput) titleInput.value = '';
            if (timeInput) timeInput.value = '';
            
            // Restablecer color seleccionado
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            const firstColor = document.querySelector('.color-option[data-color="1"]');
            if (firstColor) {
                firstColor.classList.add('selected');
            }
            selectedColorOption = '1';
        }
        
        // Función para cerrar el formulario de eventos
        function closeEventForm() {
            const overlay = document.getElementById('overlay');
            const eventForm = document.getElementById('event-form');
            
            if (overlay) overlay.style.display = 'none';
            if (eventForm) eventForm.style.display = 'none';
        }
        
        // Función para guardar evento
        function saveEvent() {
            const titleInput = document.getElementById('new-event-title');
            const timeInput = document.getElementById('new-event-time');
            
            const title = titleInput ? titleInput.value : '';
            const time = timeInput ? timeInput.value : '';
            
            if (!title.trim()) {
                alert('Por favor, ingrese un título para el evento');
                return;
            }
            
            const dateStr = formatDate(selectedDate);
            
            if (!events[dateStr]) {
                events[dateStr] = [];
            }
            
            const newEvent = {
                id: nextEventId++,
                title: title,
                time: time,
                color: selectedColorOption,
                backgroundColor: getColorForCode(selectedColorOption),
                textColor: '#FFFFFF',
                startEditable: true,
                durationEditable: true,
                display: '',
                extendedProps: '',
                editable: true
            };
            
            events[dateStr].push(newEvent);
            
            // Guardar en localStorage
            localStorage.setItem('calendarEvents', JSON.stringify(events));
            
            closeEventForm();
            renderCalendar();
            updateSidePanel();
        }
        
        // Función para actualizar el panel lateral
        function updateSidePanel() {
            // Esta función actualiza el panel lateral con información del día/evento seleccionado
            console.log('Panel lateral actualizado');
        }
        
        // Función para actualizar evento existente
        function updateEvent() {
            console.log('Actualizando evento existente');
        }
        
        // Función para resetear el formulario de evento
        function resetEventForm() {
            console.log('Reseteando formulario de evento');
        }

        // Funcionalidad para el formulario de citas médicas
        function initializeMedicalAppointmentForm() {
            // Elementos del formulario
            const searchPatientInput = document.getElementById('search-patient');
            const patientNameInput = document.getElementById('patient-name');
            const patientLastname1Input = document.getElementById('patient-lastname1');
            const patientLastname2Input = document.getElementById('patient-lastname2');
            const patientAddressInput = document.getElementById('patient-address');
            const patientPhoneInput = document.getElementById('patient-phone');
            const patientPhone2Input = document.getElementById('patient-phone2');
            const patientInsuranceSelect = document.getElementById('patient-insurance');
            const patientEmailInput = document.getElementById('patient-email');
            const treatmentSearchInput = document.getElementById('treatment-search');
            const treatmentNotesTextarea = document.getElementById('treatment-notes');
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            const addTreatmentBtn = document.querySelector('.btn-add-treatment');
            const doctorTags = document.querySelectorAll('.doctor-tag');
            const saveAppointmentBtn = document.getElementById('save-appointment');
            const cancelAppointmentBtn = document.getElementById('cancel-appointment');
            const historialBtn = document.querySelector('.btn-historial');
            const modificarBtn = document.querySelector('.btn-modificar');
            
            // Variables para el estado del formulario
            let selectedDoctor = 'Julieta Luna';
            let patientData = {
                name: '',
                lastname1: '',
                lastname2: '',
                address: '',
                phone: '',
                phone2: '',
                insurance: '',
                email: ''
            };
            
            // Solo continuar si los elementos existen
            if (!saveAppointmentBtn) return;
            
            // Búsqueda de paciente
            if (searchPatientInput) {
                searchPatientInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim().toLowerCase();
                    
                    // Simulación de búsqueda de paciente
                    if (searchTerm.length > 2) {
                        console.log('Buscando paciente:', searchTerm);
                        
                        // Ejemplo de autocompletado
                        if (searchTerm.includes('victor')) {
                            fillPatientData({
                                name: 'VICTOR MANUEL',
                                lastname1: 'LUNA',
                                lastname2: 'RAMOS',
                                address: 'Av. Principal 123',
                                phone: '555-1234',
                                phone2: '555-5678',
                                insurance: 'seguro1',
                                email: 'victor.luna@email.com'
                            });
                        }
                    }
                });
            }
            
            // Función para llenar los datos del paciente
            function fillPatientData(data) {
                patientData = data;
                if (patientNameInput) patientNameInput.value = data.name;
                if (patientLastname1Input) patientLastname1Input.value = data.lastname1;
                if (patientLastname2Input) patientLastname2Input.value = data.lastname2;
                if (patientAddressInput) patientAddressInput.value = data.address;
                if (patientPhoneInput) patientPhoneInput.value = data.phone;
                if (patientPhone2Input) patientPhone2Input.value = data.phone2;
                if (patientInsuranceSelect) patientInsuranceSelect.value = data.insurance;
                if (patientEmailInput) patientEmailInput.value = data.email;
            }
            
            // Agregar tratamiento
            if (addTreatmentBtn && treatmentSearchInput && treatmentNotesTextarea) {
                addTreatmentBtn.addEventListener('click', function() {
                    const treatmentText = treatmentSearchInput.value.trim();
                    if (treatmentText) {
                        const currentNotes = treatmentNotesTextarea.value;
                        const newNote = currentNotes ? `${currentNotes}\n- ${treatmentText}` : `- ${treatmentText}`;
                        treatmentNotesTextarea.value = newNote;
                        treatmentSearchInput.value = '';
                    }
                });
            }
            
            // Selección de médico
            doctorTags.forEach(tag => {
                tag.addEventListener('click', function() {
                    doctorTags.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    selectedDoctor = this.textContent.trim();
                    console.log('Médico seleccionado:', selectedDoctor);
                });
            });
            
            // Botón historial
            if (historialBtn) {
                historialBtn.addEventListener('click', function() {
                    alert('Mostrando historial del paciente...');
                    console.log('Abrir historial del paciente');
                });
            }
            
            // Botón modificar datos
            if (modificarBtn) {
                modificarBtn.addEventListener('click', function() {
                    const inputs = document.querySelectorAll('.patient-data-section input, .patient-data-section select');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.style.backgroundColor = '#ffffff';
                    });
                    alert('Campos habilitados para edición');
                });
            }
            
            // Validación de campos obligatorios
            function validateForm() {
                const requiredFields = [
                    { field: patientNameInput, name: 'Nombre' },
                    { field: patientLastname1Input, name: 'Apellido paterno' },
                    { field: patientLastname2Input, name: 'Apellido materno' },
                    { field: patientPhoneInput, name: 'Teléfono' },
                    { field: patientEmailInput, name: 'Correo electrónico' }
                ];
                
                const errors = [];
                
                requiredFields.forEach(({ field, name }) => {
                    if (field && !field.value.trim()) {
                        errors.push(name);
                        field.style.borderColor = '#f44336';
                    } else if (field) {
                        field.style.borderColor = '#ddd';
                    }
                });
                
                // Validar formato de email
                if (patientEmailInput) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (patientEmailInput.value.trim() && !emailRegex.test(patientEmailInput.value.trim())) {
                        errors.push('Formato de correo electrónico inválido');
                        patientEmailInput.style.borderColor = '#f44336';
                    }
                }
                
                return errors;
            }
            
            // Guardar cita
            saveAppointmentBtn.addEventListener('click', function() {
                const errors = validateForm();
                
                if (errors.length > 0) {
                    alert('Por favor, complete los siguientes campos obligatorios:\n- ' + errors.join('\n- '));
                    return;
                }
                
                const appointmentData = {
                    patient: {
                        name: patientNameInput ? patientNameInput.value.trim() : '',
                        lastname1: patientLastname1Input ? patientLastname1Input.value.trim() : '',
                        lastname2: patientLastname2Input ? patientLastname2Input.value.trim() : '',
                        address: patientAddressInput ? patientAddressInput.value.trim() : '',
                        phone: patientPhoneInput ? patientPhoneInput.value.trim() : '',
                        phone2: patientPhone2Input ? patientPhone2Input.value.trim() : '',
                        insurance: patientInsuranceSelect ? patientInsuranceSelect.value : '',
                        email: patientEmailInput ? patientEmailInput.value.trim() : ''
                    },
                    treatment: treatmentNotesTextarea ? treatmentNotesTextarea.value.trim() : '',
                    startTime: startTimeInput ? startTimeInput.value : '',
                    endTime: endTimeInput ? endTimeInput.value : '',
                    doctor: selectedDoctor,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Datos de la cita:', appointmentData);
                
                // Crear evento en el calendario
                const startDate = new Date(appointmentData.startTime);
                const endDate = new Date(appointmentData.endTime);
                const dateStr = formatDate(startDate);
                
                if (!events[dateStr]) {
                    events[dateStr] = [];
                }
                
                const newAppointment = {
                    id: nextEventId++,
                    title: `${appointmentData.patient.name} ${appointmentData.patient.lastname1} - ${appointmentData.doctor}`,
                    time: startDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    color: '2',
                    backgroundColor: '#2196F3',
                    textColor: '#FFFFFF',
                    startEditable: true,
                    durationEditable: true,
                    display: '',
                    extendedProps: JSON.stringify(appointmentData),
                    editable: true,
                    appointmentData: appointmentData
                };
                
                events[dateStr].push(newAppointment);
                
                // Guardar en localStorage
                localStorage.setItem('calendarEvents', JSON.stringify(events));
                
                // Actualizar calendario
                renderCalendar();
                
                // Enviar datos al backend
                sendAppointmentToBackend(appointmentData);
                
                // Mostrar confirmación
                alert('Cita agendada exitosamente');
                
                // Limpiar formulario
                resetAppointmentForm();
            });
            
            // Función para enviar cita al backend
            function sendAppointmentToBackend(appointmentData) {
                // Simulación de envío AJAX
                fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cita guardada en el backend:', data);
                })
                .catch(error => {
                    console.error('Error al guardar la cita:', error);
                });
            }
            
            // Cancelar/Cerrar
            if (cancelAppointmentBtn) {
                cancelAppointmentBtn.addEventListener('click', function() {
                    if (confirm('¿Está seguro de que desea cerrar sin guardar?')) {
                        resetAppointmentForm();
                    }
                });
            }
            
            // Función para resetear el formulario de cita
            function resetAppointmentForm() {
                // Limpiar campos del paciente
                if (searchPatientInput) searchPatientInput.value = '';
                if (patientNameInput) patientNameInput.value = '';
                if (patientLastname1Input) patientLastname1Input.value = '';
                if (patientLastname2Input) patientLastname2Input.value = '';
                if (patientAddressInput) patientAddressInput.value = '';
                if (patientPhoneInput) patientPhoneInput.value = '';
                if (patientPhone2Input) patientPhone2Input.value = '';
                if (patientInsuranceSelect) patientInsuranceSelect.value = '';
                if (patientEmailInput) patientEmailInput.value = '';
                if (treatmentSearchInput) treatmentSearchInput.value = 'REVISION';
                if (treatmentNotesTextarea) treatmentNotesTextarea.value = '';
                
                // Resetear selección de médico
                doctorTags.forEach(tag => tag.classList.remove('active'));
                if (doctorTags.length > 0) {
                    doctorTags[0].classList.add('active');
                    selectedDoctor = 'Julieta Luna';
                }
                
                // Resetear fechas
                if (startTimeInput && endTimeInput) {
                    const now = new Date();
                    const startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0);
                    const endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 30);
                    
                    startTimeInput.value = startTime.toISOString().slice(0, 16);
                    endTimeInput.value = endTime.toISOString().slice(0, 16);
                }
                
                // Resetear estilos de validación
                document.querySelectorAll('.patient-data-section input, .patient-data-section select').forEach(field => {
                    field.style.borderColor = '#ddd';
                });
                
                patientData = {
                    name: '',
                    lastname1: '',
                    lastname2: '',
                    address: '',
                    phone: '',
                    phone2: '',
                    insurance: '',
                    email: ''
                };
            }
            
            // Autocompletar tratamientos
            if (treatmentSearchInput) {
                treatmentSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    // Lista de tratamientos comunes
                    const commonTreatments = [
                        'REVISION',
                        'LIMPIEZA DENTAL',
                        'EXTRACCIÓN',
                        'ENDODONCIA',
                        'ORTODONCIA',
                        'BLANQUEAMIENTO',
                        'IMPLANTE',
                        'PRÓTESIS',
                        'CIRUGÍA ORAL',
                        'PERIODONCIA'
                    ];
                    
                    console.log('Buscando tratamientos para:', searchTerm);
                });
            }
        }
    </script>
</body>
</html>